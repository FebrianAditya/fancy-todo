<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-signin-client_id" content="1052799407511-50jorihbhk0g4jgimq1npit96ulbg0oj.apps.googleusercontent.com">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <title>Document</title>
</head>
<body>



    <!-- Navbar MainPage -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light" id="navbar-after-login">
        <img src="../assets/output-onlinepngtools.png" alt="logo" width="130" height="40">
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarText">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="#"></a>
              </li>
            <li class="nav-item active">
              <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#"></a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">List Todo</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#"></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Help</a>
            </li>
          </ul>
          <section>
                 <button type="button" class="btn btn-danger" id="logOut">Log Out</button>
          </section>
        </div>
    </nav>

    <!-- Navbar HomePage -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light" id="navbar-homePage">
      <img src="../assets/output-onlinepngtools.png" alt="logo" width="130" height="40">
    </nav>

    <div class="container">
    <!-- Home Page -->
          <section id="homePage">
              <hr>
              <button class="btn btn-primary" id="buttonAddTodo">
                  Add Todo
              </button>
              <hr>
              <Section id="cardTodo">
                
              </Section>
          </section>

          <!-- Add Form -->
          <div id="formAdd">
            <br> <br>
              <h3 class="justify-content-center">Add Form</h3> <br>
                  <form id="addForm">
                      <div class="form-group">
                        <label for="exampleInputEmail1">Title</label>
                        <input type="text" class="form-control" id="addTitle" aria-describedby="emailHelp">
                      </div>
                      <div class="form-group">
                        <label for="exampleInputPassword1">Description</label>
                        <input type="text" class="form-control" id="addDesc">
                      </div>
                        <div class="form-group">
                          <label for="exampleInputEmail1">Due Date</label>
                          <input type="date" class="form-control" id="addDueDate" aria-describedby="emailHelp">
                        </div>
                      <button type="submit" class="btn btn-primary">Submit</button>
                      <a href="#" id="backFromAddData">Back</a>
                    </form>
          </div>

          <!-- Form Edit -->
          <div id="formEdit">
            
          </div>

          <!-- Form Register -->
          <div id="pageRegister">
            <br>
              <h3>Register</h3> <br>
              <form id="formRegister">
                  <div class="form-group">
                      <label for="firstName">First Name</label>
                      <input type="text" class="form-control" id="firstNameRegister" aria-describedby="emailHelp">
                  </div>
                  <div class="form-group">
                      <label for="lastName">Last Name</label>
                      <input type="text" class="form-control" id="lastNameRegister" aria-describedby="emailHelp">
                  </div>
                  <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" class="form-control" id="emailRegister" aria-describedby="emailHelp">
                    <small id="emailHelp" class="form-text text-muted">We'll never share your email with anyone else.</small>
                  </div>
                  <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" class="form-control" id="passwordRegister">
                  </div>
                  <button type="submit" class="btn btn-primary">Register</button>
              </form>
              <a href="#" id="backLogin">Cancel</a>
          </div>

          <!-- Form LogIn -->
          <div id="pageLogIn">
            <div class="d-flex">
              <div class="col-7">
                
              </div>
              <div class="col-5">
                <br>
                <h2>Application My Todo</h2>
                <form id="formLogin">
                    <div class="form-group row">
                      <div>
                        <label for="emailLogIn" class="col-sm-2 col-form-label">Email</label> <br>
                      </div>
                      <div class="col-sm-10">
                        <input type="email" class="form-control" id="emailLogIn">
                      </div>
                    </div>
                    <div class="form-group row">
                      <div>
                        <label for="inputPassword3" class="col-sm-2 col-form-label">Password</label> 
                      </div> 
                      <div class="col-sm-10">
                        <input type="password" class="form-control" id="passwordLogIn">
                      </div>
                    </div>
                    <div class="form-group row">
                      <div class="col-sm-10">
                        <button type="submit" class="btn btn-primary">Log In</button>
                        <a href="#" id="toRegister">Register</a>
                      </div>
                     
                    </div>
                </form>
                <div class="g-signin2" data-onsuccess="onSignIn"></div>
              </div>

            </div>
          </div>
  </div>
    
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>

      function showLogIn() {
          $("#pageRegister").hide()
          $("#pageLogIn").show()
          $("#logOut").hide()
          $("#navbar-after-login").hide()
          $("#formAdd").hide()
          $("#formEdit").hide()
          $("#homePage").hide()
          $("#navbar-homePage").show()
          $("#navbar-after-login").hide()      
      }

      function showRegister() {
            $("#pageRegister").show()
            $("#navbar-homePage").show()  
            $("#pageLogIn").hide()
            $("#logOut").hide()
            $("#navbar-after-login").hide()
            $("#formAdd").hide()
            $("#formEdit").hide()
            $("#homePage").hide()
        }

      function showMainPage() {
            $("#pageRegister").hide()
            $("#pageLogIn").hide()
            $("#logOut").show()
            $("#navbar-after-login").show()
            $("#homePage").show()
            $("#formAdd").hide()
            $("#formEdit").hide()
            $("#navbar-homePage").hide()
            getTodo()
      }
       
      function showFormAdd() {
        $("#formAdd").show()
        $("#pageRegister").hide()
          $("#pageLogIn").hide()
          $("#logOut").hide()
          $("#navbar-after-login").hide()
          $("#homePage").hide()
          $("#formEdit").hide()
          $("#navbar-homePage").hide()
          $("#backFromAddData").show()
          $("#backFromAddData").on("click", () => {
            showMainPage()
          })
      }

      function collectionInputFromRegister() {
            const payload = {
                firstName: $("#firstNameRegister").val(),
                lastName: $("#lastNameRegister").val(),
                email: $("#emailRegister").val(),
                password: $("#passwordRegister").val()
            }
            return payload
        }
        
      function collectionInputFromLogIn() {
            let objLogIn = {
                email: $("#emailLogIn").val(),
                password: $("#passwordLogIn").val()
            }
            return objLogIn
        }

      function register(event) {
          event.preventDefault()
          $.ajax({
              method: "POST",
                  url: "http://localhost:3000/register",
                  data: payload
              })
              .done(res => {
                  console.log(res)
              })
              .fail((err) => {
                  console.log(err)
              })
      }

      function logOut() {
            localStorage.clear()
            $("#pageLogIn").show()
            $("#pageRegister").hide()
            $("#logOut").hide()
            $("#navbar-homePage").show()
            $("#navbar-after-login").hide()
            $("#formAdd").hide()
            $("#formEdit").hide()
            $("#homePage").hide()
        }

      function formEditTodo() {
          $("#pageRegister").hide()
            $("#navbar-homePage").hide()  
            $("#pageLogIn").hide()
            $("#logOut").hide()
            $("#formAdd").hide()
            $("#homePage").hide()
            $("#navbar-after-login").show()
            $("#formEdit").show()
      }

      function getTodo() { 
        $.ajax ({
          url: "http://localhost:3000",
          method: "GET",
          headers: {
            accestoken: localStorage.getItem("acces_token")
          }
        })
              .done(response => {
                let dataTodos = response.data
                  $("#cardTodo").empty() // setiap read jangan lupa di kosongin dulu biar ga numpuk
                  
                    dataTodos.forEach(el => {
                      if(el.status === "uncomplate") {
                        $("#cardTodo").append(`
                        <div class="card mb-5">
                          <div class="card-header">
                            Todo
                          </div>
                          <div class="card-body">
                            <h5 class="card-title">${el.title}</h5>
                            <p class="card-text">${el.description}</p>
                            <a href="#" class="btn btn-primary" onclick="editTodo(${el.id})">Edit</a>
                            <a href="#" class="btn btn-primary" onclick="deleteTodo(${el.id})">Delete</a>
                            <a href="#" class="btn btn-primary" onclick="editStatus(${el.id})">Complate</a>
                          </div>
                        </div>
                        `)
                      }else {
                        $("#cardTodo").append(`
                          <div class="card mb-5">
                            <div class="card-header">
                              Todo
                            </div>
                            <div class="card-body bg-secondary text-light">
                              <h5 class="card-title">${el.title}</h5>
                              <p class="card-text">${el.description}</p>
                              <a href="#" class="btn btn-primary" onclick="editTodo(${el.id})">Edit</a>
                              <a href="#" class="btn btn-primary" onclick="deleteTodo(${el.id})">Delete</a>
                              <a href="#" class="btn btn-primary" onclick="editStatus(${el.id})">Complate</a>
                            </div>
                          </div>
                      `)
                      }
                    })
              })
              .fail(err => {
                  console.log(err)
              })
      }

      function createTodo() {
          let objTodo = {
            title: $("#addTitle").val(),
            description: $("#addDesc").val(),
            status: "uncomplate",
            due_date: $("#addDueDate").val()
          }
          // console.log(collectionInputFormAddTodo())
          $.ajax({
            url: "http://localhost:3000",
            method: "POST",
            headers: {
              accestoken: localStorage.getItem("acces_token")
            },
            data: objTodo
          })
            .done(response => {
              showMainPage()
              
            })
            .fail(err => {
            })
            .always(() => {
              $("#addTitle").val(""),
              $("#addDesc").val(""),
              $("#addDueDate").val("")
          })
        }
      
      function deleteTodo(id) {
        // console.log(id)
        $.ajax({
          url: `http://localhost:3000/${id}`,
          method: "DELETE",
          headers: {
              accestoken: localStorage.getItem("acces_token")
          }
        })
          .done(response => {
            showMainPage()
          })
          .fail(err => {
            console.log(err)
          })
      }

      function editTodo(id) {
        // console.log(id)
        $("#formEdit").show()
        $.ajax({
            url: "http://localhost:3000/"+id,
            method: "GET",
            headers: {
              accestoken: localStorage.getItem("acces_token")
            }
          })
            .done(({ data }) => {
              console.log(data)
              formEditTodo()
              $("#formEdit").append(`
              <br>
              <h3 class="justify-content-center">Edit Form</h3>
                  <form id="editForm" onsubmit="saveDataEdit(event, ${data.id}), ${data.status}">
                      <div class="form-group">
                        <label for="exampleInputEmail1">Title</label>
                        <input type="text" class="form-control" id="inputTitleEdit" aria-describedby="emailHelp" value="${data.title}">
                      </div>
                      <div class="form-group">
                        <label for="exampleInputPassword1">Description</label>
                        <input type="text" class="form-control" id="inputDescEdit" value="${data.description}">
                      </div>
                        <div class="form-group">
                          <label for="exampleInputEmail1">Due Date</label>
                          <input type="date" class="form-control" id="inputDueDateStatus" aria-describedby="emailHelp" value="${data.due_date}">
                        </div>
                      <button type="submit" class="btn btn-primary">Submit</button>
                      <a href="#" id="backFromAddData">Back</a>
                    </form>
              `)
              $("#backFromAddData").on("click", () => {
                showMainPage()
              })
              
            })
            .catch(err => {
              console.log(err)
            })
      }

      function editStatus(id) {
        let status = "complete"
        $.ajax({
            url: "http://localhost:3000/"+id,
            method: "PATCH",
            headers: {
              accestoken: localStorage.getItem("acces_token")
            },
            data: {
              status
            }
          })
              .done(response => {
                showMainPage()
              })
              .fail(err => {
                console.log(err)
              })
      }

      function onSignIn(googleUser) {
        var googleToken = googleUser.getAuthResponse().id_token;
        $.ajax({
          url: `http://localhost:3000/googlelogin`,
          method: "POST",
          data: {
            googleToken
          }
        })
          .done((response) => {
            console.log(response)
              localStorage.setItem('acces_token', response.accestoken);

              showMainPage()
          })

          .fail((jqxhr, status) => {
              console.log(jqxhr.responseJSON);
          })

          .always(() => {
              $("#emailLogIn").val("")
              $("#passwordLogIn").val("")
          })
      }
       
      function saveDataEdit(event, id, statusDataBase) {
        event.preventDefault()
        $("#editForm").on("submit", () => {
          let title = $("#inputTitleEdit").val()
          let description = $("#inputDescEdit").val()
          let status = statusDataBase
          let due_date = $("#inputDueDateStatus").val()
          
  
          $.ajax({
              url: "http://localhost:3000/"+id,
              method: "PUT",
              headers: {
                accestoken: localStorage.getItem("acces_token")
              },
              data: {
                title,
                description,
                status,
                due_date
              }
          })
            .done(response => {
              showMainPage()
            })
            .fail(err => {
              console.log(err)
            })
         

        })
        
      }
      
      $(document).ready(function(){ 
            if(localStorage.getItem("acces_token")) {
                showMainPage()
            }else {
                showLogIn()
            }
            
            $("#formLogin").on("submit", (event) => {
                event.preventDefault()
                // console.log(collectionInputFromLogIn())
                $.ajax({
                    url: "http://localhost:3000/login",
                    method: "POST",
                    data: collectionInputFromLogIn()
                })
                    .done(response => {
                        const acces_token = response.accesToken
                        localStorage.setItem("acces_token", acces_token)                   
                        showMainPage()
                    })
                    .fail((xhr, textStatus) => {
                        console.log(xhr, textStatus)
                    })
                    .always(() => { // untuk mengosongkan, jangan lupa dikosongkan dengan cara ini
                      $("#emailLogIn").val(""),
                      $("#passwordLogIn").val("")
                    })
            })
            
            $("#logOut").on("click", () => {
              logOut()
              var auth2 = gapi.auth2.getAuthInstance();
              auth2.signOut().then(function () {
                console.log('User signed out.');
              })
            })

            // Tombol Ke Register
            $("#toRegister").on("click", () => {
                showRegister()
            })

            // Tombol Back Ke log In
            $("#backLogin").on("click", () => {
                showLogIn()
            })

            $("#buttonAddTodo").on("click", (event) => {
              event.preventDefault()
              showFormAdd()
            })

            $("#addForm").on("submit", (event) => {
              event.preventDefault()
              createTodo()
            })


            
        });
         
    </script>
</body>
</html>